generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUM
//////////////////////

enum Gender {
  L
  P
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum BookingMode {
  FLEXIBLE // lapangan, ruangan
  FIXED_SLOT // bus, travel, event
}

enum WeekDay {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

//////////////////////
// AUTH & USER
//////////////////////

model Role {
  id   Int    @id @default(autoincrement())
  name String
  slug String @unique

  users User[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model User {
  id            Int        @id @default(autoincrement())
  email         String     @unique
  username      String     @unique
  password      String
  status        UserStatus @default(ACTIVE)
  image         String?
  rememberToken String?

  roleId Int
  role   Role @relation(fields: [roleId], references: [id])

  customer     Customer?
  accessTokens UserAccessToken[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model UserAccessToken {
  id         Int       @id @default(autoincrement())
  userId     Int
  token      String    @unique
  expiredAt  DateTime?
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Customer {
  id      Int     @id @default(autoincrement())
  userId  Int     @unique
  name    String
  phone   String
  address String?
  gender  Gender?

  user     User      @relation(fields: [userId], references: [id])
  bookings Booking[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

//////////////////////
// RESOURCE
//////////////////////

model Resource {
  id          Int         @id @default(autoincrement())
  name        String
  type        String
  bookingMode BookingMode
  capacity    Int?
  description String?

  weeklySchedules WeeklySchedule[]
  timeSlots       TimeSlot[]
  bookings        Booking[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

//////////////////////
// SCHEDULE
//////////////////////

// Untuk lapangan & ruangan
model WeeklySchedule {
  id         Int     @id @default(autoincrement())
  resourceId Int
  day        WeekDay

  openTime  String // "07:00"
  closeTime String // "22:00"

  pricePerHour BigInt?

  resource Resource @relation(fields: [resourceId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([resourceId, day])
}

// Untuk bus & slot fix
model TimeSlot {
  id         Int     @id @default(autoincrement())
  resourceId Int
  day        WeekDay

  startTime String // "02:00"
  endTime   String? // optional
  price     BigInt?

  resource Resource  @relation(fields: [resourceId], references: [id])
  bookings Booking[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

//////////////////////
// BOOKING
//////////////////////

model Booking {
  id         Int @id @default(autoincrement())
  customerId Int
  resourceId Int

  date      DateTime // tanggal booking (YYYY-MM-DD)
  startTime String // "13:00"
  endTime   String? // "17:00" (null untuk FIXED_SLOT)

  timeSlotId Int? // hanya terisi kalau FIXED_SLOT

  quantity   Int           @default(1)
  totalPrice BigInt
  status     BookingStatus @default(PENDING)

  customer Customer  @relation(fields: [customerId], references: [id])
  resource Resource  @relation(fields: [resourceId], references: [id])
  timeSlot TimeSlot? @relation(fields: [timeSlotId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}
